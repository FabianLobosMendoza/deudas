{% extends "finanzas/base.html" %}

{% block title %}Resumen - Tablero financiero{% endblock %}

{% block content %}
<h2>Resumen del mes</h2>

<div class="top-actions">
    <!-- Botón: ir a listado/altas de ingresos -->
    <a class="btn" href="{% url 'finanzas:lista_ingresos' %}">Ingresos</a>
    <!-- Botón: ir a listado/altas de gastos -->
    <a class="btn" href="{% url 'finanzas:lista_gastos' %}">Gastos</a>
    <!-- Botón: ir a importar/exportar CSV -->
    <a class="btn" href="{% url 'finanzas:importar_exportar' %}">Importar / Exportar CSV</a>
</div>

<div class="cards">
    <div class="card">
        <h2>Deuda total</h2>
        <div class="value">${{ deuda_total|floatformat:2 }}</div>
    </div>
    <div class="card">
        <h2>Cuota fija mensual total</h2>
        <div class="value">${{ cuota_fija_total|floatformat:2 }}</div>
    </div>
    <div class="card">
        <h2>Ingresos del mes</h2>
        <div class="value">${{ ingresos_mes|floatformat:2 }}</div>
    </div>
    <div class="card">
        <h2>Gastos del mes</h2>
        <div class="value">${{ gastos_mes|floatformat:2 }}</div>
    </div>
    <div class="card">
        <h2>Saldo del mes</h2>
        <div class="value">${{ saldo_mes|floatformat:2 }}</div>
    </div>
    <div class="card">
        <h2>Cuotas / Ingresos</h2>
        <div class="value">{{ relacion_cuotas_ingresos|floatformat:1 }}%</div>
    </div>
</div>

<h2>Gastos por vencer (30 dias)</h2>
<table>
    <thead>
        <tr>
            <th>Fecha</th>
            <th>Descripcion</th>
            <th>Monto</th>
            <th>Estado</th>
        </tr>
    </thead>
    <tbody>
    {% for g in gastos_pendientes %}
        <tr>
            <td>{{ g.fecha }}</td>
            <td>{{ g.descripcion }}</td>
            <td>${{ g.monto|floatformat:2 }}</td>
            <td>
                {% if g.estado_vencimiento == 'vencido' %}
                    <span class="badge badge-alta">Vencido</span>
                {% elif g.estado_vencimiento == 'hoy' %}
                    <span class="badge badge-media">Vence hoy</span>
                {% elif g.estado_vencimiento == 'por_vencer' %}
                    <span class="badge badge-media">En {{ g.dias_para_vencer }} dias</span>
                {% else %}
                    <span class="badge">Pendiente</span>
                {% endif %}
            </td>
        </tr>
    {% empty %}
        <tr><td colspan="4">No hay vencimientos proximos.</td></tr>
    {% endfor %}
    </tbody>
</table>

<div style="background:white;border-radius:1rem;padding:1rem 1.25rem;box-shadow:0 10px 30px rgba(0,0,0,0.06);margin-bottom:1rem;">
    <h2 style="margin-top:0;">Ingresos vs gastos por dia</h2>
    <form method="get" style="display:flex;gap:0.75rem;align-items:center;margin:0 0 1rem;flex-wrap:wrap;">
        <label for="month" style="font-weight:600;">Mes:</label>
        <input type="month" id="month" name="month" value="{{ month_str }}" style="padding:0.4rem 0.6rem;border:1px solid #d1d5db;border-radius:0.5rem;">
        <button type="submit" class="btn">Ver</button>
    </form>
    <canvas id="ingresosGastosDiaChart" style="width:100%;max-width:100%;background:#f9fafb;border:1px dashed #e5e7eb;border-radius:0.75rem;min-height:240px;height:240px;"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    (function () {
        const diasLabels = {{ dias_labels|safe }};
        const ingresosData = {{ ingresos_por_dia|safe }};
        const gastosData = {{ gastos_por_dia|safe }};
        const sobranteData = {{ sobrante_por_dia|safe }};

        const ctx = document.getElementById('ingresosGastosDiaChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: diasLabels,
                datasets: [
                    {
                        label: 'Ingresos',
                        data: ingresosData,
                        backgroundColor: 'rgba(34, 197, 94, 0.8)',
                    },
                    {
                        label: 'Gastos',
                        data: gastosData,
                        backgroundColor: 'rgba(239, 68, 68, 0.8)',
                    },
                    {
                        type: 'line',
                        label: 'Sobrante acumulado',
                        data: sobranteData,
                        borderColor: 'rgba(37, 99, 235, 0.9)',
                        backgroundColor: 'rgba(37, 99, 235, 0.15)',
                        fill: false,
                        tension: 0.2,
                        pointRadius: 3,
                        yAxisID: 'y',
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: false,
                    },
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Dia del mes',
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Monto',
                        },
                        beginAtZero: true,
                    }
                }
            }
        });
    })();
</script>

{% endblock %}
